% =============================================================================
% PREAMBLE - Textbook Style with Margin Notes, Callout Boxes, and Custom Fonts
% =============================================================================

% -----------------------------------------------------------------------------
% PAGE GEOMETRY - Wide margins for margin notes
% -----------------------------------------------------------------------------
\usepackage[
  papersize={8.5in,11in},
  left=1in,
  right=3in,           % Wide right margin for notes
  top=1in,
  bottom=1in,
  marginparwidth=2.25in,
  marginparsep=0.25in
]{geometry}

% -----------------------------------------------------------------------------
% FONTS - Using fontspec for custom fonts (requires LuaLaTeX or XeLaTeX)
% -----------------------------------------------------------------------------
\usepackage{fontspec}
\setmainfont{Latin Modern Roman}  % Or use: TeX Gyre Termes, Libertinus Serif
\setsansfont{Latin Modern Sans}
\setmonofont{Latin Modern Mono}[Scale=0.9]

% Alternative: Use system fonts
% \setmainfont{Georgia}
% \setsansfont{Helvetica Neue}
% \setmonofont{SF Mono}[Scale=0.85]

% -----------------------------------------------------------------------------
% TYPOGRAPHY
% -----------------------------------------------------------------------------
\usepackage{microtype}           % Better text justification
\usepackage{setspace}            % Line spacing
\onehalfspacing                  % 1.5 line spacing for readability

% Paragraph settings
\setlength{\parindent}{1.5em}    % First line indent
\setlength{\parskip}{0pt}        % No extra space between paragraphs

% -----------------------------------------------------------------------------
% COLORS - Red accent scheme matching Evals style
% -----------------------------------------------------------------------------
\usepackage{xcolor}

% Primary accent color (red)
\definecolor{accentred}{HTML}{C41E3A}      % Cardinal red for headers, page numbers
\definecolor{linkred}{HTML}{C41E3A}        % Red for URLs
\definecolor{linkblue}{HTML}{2B6CB0}       % Blue for citations

% Box colors
\definecolor{grayheader}{HTML}{4A5568}     % Gray header for definition boxes
\definecolor{graybg}{HTML}{F7FAFC}         % Light gray background
\definecolor{promptheader}{HTML}{2B6CB0}   % Blue/teal for prompt headers
\definecolor{promptbg}{HTML}{EBF4FF}       % Light blue background for prompts
\definecolor{codebg}{HTML}{FAFAF8}         % Cream background for code
\definecolor{takeawayred}{HTML}{C41E3A}    % Red for key takeaway labels

% -----------------------------------------------------------------------------
% HEADERS AND FOOTERS - Right-aligned small caps title + red page number
% -----------------------------------------------------------------------------
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}  % Clear all headers/footers

% Running header: small caps title right-aligned, red page number
\fancyhead[R]{\small\textsc{\@title} \quad \textcolor{accentred}{\thepage}}
\renewcommand{\headrulewidth}{0pt}  % No header line

% Store title for header use
\let\oldtitle\title
\renewcommand{\title}[1]{\oldtitle{#1}\newcommand{\thetitle}{#1}}

% -----------------------------------------------------------------------------
% SECTION FORMATTING - Numbered sections with italic titles
% -----------------------------------------------------------------------------
\usepackage{titlesec}

% Section: "1.1 Title" with title in italics
\titleformat{\section}
  {\normalfont\large\bfseries}  % Format
  {\thesection}                  % Label
  {1em}                          % Sep between number and title
  {\itshape}                     % Title in italics

% Subsection
\titleformat{\subsection}
  {\normalfont\normalsize\bfseries}
  {\thesubsection}
  {1em}
  {\itshape}

% Spacing: before, after
\titlespacing*{\section}{0pt}{2ex plus 1ex minus .2ex}{1ex plus .2ex}
\titlespacing*{\subsection}{0pt}{1.5ex plus .5ex minus .2ex}{0.5ex plus .2ex}

% -----------------------------------------------------------------------------
% MARGIN NOTES - Right-side annotations with attribution support
% -----------------------------------------------------------------------------
\usepackage{marginnote}
\renewcommand*{\marginfont}{\footnotesize}
\usepackage{sidenotes}  % Better sidenote support

% Plain margin note
\newcommand{\marginnotetext}[1]{%
  \marginnote{\raggedright\footnotesize\itshape #1}%
}

% Attributed margin note (e.g., "Shreya's Note:")
\newcommand{\authornote}[2]{%
  \marginnote{\raggedright\footnotesize\textbf{#1's Note:} \itshape #2}%
}

% -----------------------------------------------------------------------------
% CALLOUT BOXES - Using tcolorbox
% -----------------------------------------------------------------------------
\usepackage[most]{tcolorbox}
\tcbuselibrary{skins, breakable}

% 1. INFORMATIONAL CALLOUT (e.g., "Note to readers") - gray style
\newtcolorbox{infobox}[1][Note]{
  enhanced,
  breakable,
  colback=graybg,
  colframe=graybg,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=0pt,
  bottom=12pt,
  toptitle=8pt,
  bottomtitle=8pt,
  title={\textbf{#1}},
  coltitle=white,
  colbacktitle=grayheader,
  fonttitle=\bfseries\sffamily
}

% 2. DEFINITION BOX - Gray header bar, white content, no border
\newtcolorbox{definitionbox}[1][Definition]{
  enhanced,
  breakable,
  colback=white,
  colframe=white,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=0pt,
  bottom=12pt,
  toptitle=8pt,
  bottomtitle=8pt,
  title={\textbf{#1}},
  coltitle=white,
  colbacktitle=grayheader,
  fonttitle=\bfseries\sffamily,
  shadow={0pt}{0pt}{0pt}{graybg}
}

% 3. SAMPLE PROMPT BOX - Blue/teal header bar with label
\newcounter{promptcount}
\newtcolorbox{promptbox}[1][Sample Prompt]{
  enhanced,
  breakable,
  colback=promptbg,
  colframe=promptbg,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=0pt,
  bottom=12pt,
  toptitle=8pt,
  bottomtitle=8pt,
  title={\textbf{#1}},
  coltitle=white,
  colbacktitle=promptheader,
  fonttitle=\bfseries\sffamily
}

% 4. KEY TAKEAWAY BOX - Red label, numbered
\newcounter{takeawaycount}
\newtcolorbox{takeawaybox}{
  enhanced,
  breakable,
  colback=white,
  colframe=takeawayred,
  boxrule=1.5pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=12pt,
  bottom=12pt,
  before upper={\refstepcounter{takeawaycount}\textcolor{takeawayred}{\textbf{Key Takeaway \thetakeawaycount}}\par\vspace{6pt}}
}

% 5. SOLUTION BOX (numbered, light gray background)
\newcounter{solutioncount}
\newtcolorbox{solutionbox}[1][]{
  enhanced,
  breakable,
  colback=graybg,
  colframe=graybg,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=12pt,
  bottom=12pt,
  before upper={\refstepcounter{solutioncount}\textbf{Solution \thesolutioncount}\par\vspace{6pt}},
  #1
}

% 6. WARNING NOTICE (red text, centered, small caps)
\newcommand{\warningnotice}[1]{%
  \begin{center}
    \textcolor{accentred}{\textsc{\MakeUppercase{#1}}}
  \end{center}
}

% -----------------------------------------------------------------------------
% CODE LISTINGS
% -----------------------------------------------------------------------------
\usepackage{listings}
\lstset{
  basicstyle=\ttfamily\small,
  breaklines=true,
  breakatwhitespace=true,
  columns=flexible,
  keepspaces=true,
  showstringspaces=false,
  backgroundcolor=\color{codebg},
  frame=none,
  xleftmargin=0pt,
  xrightmargin=0pt,
  aboveskip=6pt,
  belowskip=6pt
}

% Inline code command
\newcommand{\code}[1]{\texttt{#1}}

% -----------------------------------------------------------------------------
% LISTS - Customized bullets and lettered items
% -----------------------------------------------------------------------------
\usepackage{enumitem}

% Bullet list with solid dots
\setlist[itemize]{
  label=\textbullet,
  leftmargin=2em,
  itemsep=3pt,
  parsep=0pt
}

% Lettered lists: (a), (b), (c)
\setlist[enumerate,1]{
  label=(\alph*),
  leftmargin=2em,
  itemsep=3pt,
  parsep=0pt
}

% Nested bullets
\setlist[itemize,2]{
  label=\textendash,
  leftmargin=1.5em
}

% -----------------------------------------------------------------------------
% BIBLIOGRAPHY - Author-date format
% -----------------------------------------------------------------------------
\usepackage[
  backend=biber,
  style=authoryear,
  sorting=nyt,
  natbib=true,
  maxcitenames=2,
  maxbibnames=10
]{biblatex}

% -----------------------------------------------------------------------------
% HYPERLINKS - Blue citations, red URLs
% -----------------------------------------------------------------------------
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=black,
  citecolor=linkblue,
  urlcolor=linkred,
  pdfauthor={},
  pdftitle={}
}

% -----------------------------------------------------------------------------
% MISCELLANEOUS
% -----------------------------------------------------------------------------
\usepackage{graphicx}           % Images
\usepackage{booktabs}           % Better tables
\usepackage{caption}            % Caption customization
\usepackage{float}              % Figure placement

% Caption styling
\captionsetup{
  font=small,
  labelfont=bf,
  margin=0pt
}

% Prevent orphans and widows
\widowpenalty=10000
\clubpenalty=10000

% -----------------------------------------------------------------------------
% CUSTOM COMMANDS
% -----------------------------------------------------------------------------

% Defined term (italics)
\newcommand{\term}[1]{\textit{#1}}

% Technical term (monospace)
\newcommand{\tech}[1]{\texttt{#1}}

% Strong emphasis (renamed to avoid conflict with existing \strong)
\renewcommand{\strong}[1]{\textbf{#1}}
