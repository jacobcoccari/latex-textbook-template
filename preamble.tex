% =============================================================================
% PREAMBLE - Textbook Style with Margin Notes, Callout Boxes, and Custom Fonts
% =============================================================================

% -----------------------------------------------------------------------------
% PAGE GEOMETRY - Wide margins for margin notes
% -----------------------------------------------------------------------------
\usepackage[
  papersize={8.5in,11in},
  left=1in,
  right=3in,           % Wide right margin for notes
  top=1in,
  bottom=1in,
  marginparwidth=2.25in,
  marginparsep=0.25in,
  headheight=14pt      % Fix fancyhdr warning
]{geometry}

% -----------------------------------------------------------------------------
% FONTS - Using fontspec for custom fonts (requires LuaLaTeX or XeLaTeX)
% -----------------------------------------------------------------------------
\usepackage{fontspec}
\setmainfont{Latin Modern Roman}
\setsansfont{Latin Modern Sans}
\setmonofont{Latin Modern Mono}[Scale=0.9]

% -----------------------------------------------------------------------------
% TYPOGRAPHY
% -----------------------------------------------------------------------------
\usepackage{microtype}
\usepackage{setspace}
\onehalfspacing

\setlength{\parindent}{1.5em}
\setlength{\parskip}{0pt}

% -----------------------------------------------------------------------------
% COLORS - Exact specifications
% -----------------------------------------------------------------------------
\usepackage{xcolor}

% Header and accent colors
\definecolor{headerred}{HTML}{AA0000}       % Running header, URLs

% Hyperlink colors
\definecolor{citeblue}{HTML}{2471A3}        % Citations
\definecolor{urlred}{HTML}{AA0000}          % URLs

% Box colors
\definecolor{tealheader}{HTML}{48B5A6}      % Solution/Prompt header bars (lightened)
\definecolor{charcoalheader}{HTML}{4A4A4A}  % Definition box headers
\definecolor{graybar}{HTML}{555555}         % Info box left bar
\definecolor{grayfill}{HTML}{F7F7F7}        % Info box fill
\definecolor{lightgray}{HTML}{F5F5F5}       % Solution box body
\definecolor{coralred}{HTML}{C94C4C}        % Key takeaway label/border
\definecolor{salmonbg}{HTML}{FDF2F2}        % Key takeaway background
\definecolor{codebg}{HTML}{FAFAFA}          % Code background

% -----------------------------------------------------------------------------
% HEADERS AND FOOTERS - Red text, small caps, right-aligned
% -----------------------------------------------------------------------------
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}

% Running header: red small caps title + red page number, right-aligned
\fancyhead[R]{\textcolor{headerred}{\small\textsc{\thetitle} \quad \thepage}}
\renewcommand{\headrulewidth}{0pt}

% Store title for header use
\newcommand{\thetitle}{Document Title}
\let\oldtitle\title
\renewcommand{\title}[1]{\oldtitle{#1}\renewcommand{\thetitle}{#1}}

% -----------------------------------------------------------------------------
% SECTION FORMATTING
% -----------------------------------------------------------------------------
\usepackage{titlesec}

\titleformat{\section}
  {\normalfont\Large\bfseries}
  {\thesection}
  {1em}
  {\itshape}

\titleformat{\subsection}
  {\normalfont\large\bfseries}
  {\thesubsection}
  {1em}
  {\itshape}

\titlespacing*{\section}{0pt}{2ex plus 1ex minus .2ex}{1ex plus .2ex}
\titlespacing*{\subsection}{0pt}{1.5ex plus .5ex minus .2ex}{0.5ex plus .2ex}

% -----------------------------------------------------------------------------
% MARGIN NOTES
% -----------------------------------------------------------------------------
\usepackage{marginnote}
\renewcommand*{\marginfont}{\footnotesize}
\usepackage{sidenotes}

\newcommand{\marginnotetext}[1]{%
  \marginnote{\raggedright\footnotesize\itshape #1}%
}

\newcommand{\authornote}[2]{%
  \marginnote{\raggedright\footnotesize\textbf{#1's Note:} \itshape #2}%
}

% -----------------------------------------------------------------------------
% CALLOUT BOXES - Using tcolorbox
% -----------------------------------------------------------------------------
\usepackage[most]{tcolorbox}
\tcbuselibrary{skins, breakable}

% 1. INFO/NOTE BOX - Gray left bar, light gray fill
\newtcolorbox{infobox}[1][Note]{
  enhanced,
  breakable,
  colback=grayfill,
  colframe=grayfill,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=12pt,
  bottom=12pt,
  borderline west={3pt}{0pt}{graybar},
  before upper={\textbf{#1}\par\vspace{6pt}}
}

% 2. DEFINITION BOX - Dark charcoal header (#4A4A4A), white text
\newtcolorbox{definitionbox}[1][Definition]{
  enhanced,
  breakable,
  colback=white,
  colframe=white,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=0pt,
  bottom=12pt,
  toptitle=8pt,
  bottomtitle=8pt,
  title={\textbf{#1}},
  coltitle=white,
  colbacktitle=charcoalheader,
  fonttitle=\bfseries\sffamily
}

% 3. SOLUTION BOX - Teal header bar, light gray body, teal left border
\newcounter{solutioncount}
\newtcolorbox{solutionbox}{
  enhanced,
  breakable,
  colback=lightgray,
  colframe=lightgray,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=0pt,
  bottom=12pt,
  toptitle=8pt,
  bottomtitle=8pt,
  borderline west={3pt}{0pt}{tealheader},
  before upper={\refstepcounter{solutioncount}},
  title={\textbf{Solution \thesolutioncount}},
  coltitle=white,
  colbacktitle=tealheader,
  fonttitle=\bfseries\sffamily
}

% 4. SAMPLE PROMPT BOX - Simple design with left accent bar, monospace content
\definecolor{promptaccent}{HTML}{6366F1}    % Indigo accent for prompts
\definecolor{promptbg}{HTML}{F8FAFC}        % Very light gray background
\newtcolorbox{promptbox}[1][Sample Prompt]{
  enhanced,
  breakable,
  colback=promptbg,
  colframe=promptbg,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=12pt,
  bottom=12pt,
  borderline west={3pt}{0pt}{promptaccent},
  before upper={\textcolor{promptaccent}{\textbf{#1}}\par\vspace{6pt}\ttfamily}
}

% 5. KEY TAKEAWAY BOX - Red/coral label, salmon background, red left border
\newcounter{takeawaycount}
\newtcolorbox{takeawaybox}{
  enhanced,
  breakable,
  colback=salmonbg,
  colframe=salmonbg,
  boxrule=0pt,
  arc=0pt,
  left=12pt,
  right=12pt,
  top=12pt,
  bottom=12pt,
  borderline west={3pt}{0pt}{coralred},
  before upper={\refstepcounter{takeawaycount}\textcolor{coralred}{\textbf{Key Takeaway \thetakeawaycount}}\par\vspace{6pt}}
}

% 6. WARNING NOTICE - Red text, centered, small caps
\newcommand{\warningnotice}[1]{%
  \begin{center}
    \textcolor{headerred}{\textsc{\MakeUppercase{#1}}}
  \end{center}
}

% -----------------------------------------------------------------------------
% CODE LISTINGS
% -----------------------------------------------------------------------------
\usepackage{listings}
\lstset{
  basicstyle=\ttfamily\small,
  breaklines=true,
  breakatwhitespace=true,
  columns=flexible,
  keepspaces=true,
  showstringspaces=false,
  backgroundcolor=\color{codebg},
  frame=none,
  xleftmargin=0pt,
  xrightmargin=0pt,
  aboveskip=6pt,
  belowskip=6pt
}

\newcommand{\code}[1]{\texttt{#1}}

% -----------------------------------------------------------------------------
% LISTS
% -----------------------------------------------------------------------------
\usepackage{enumitem}

\setlist[itemize]{
  label=\textbullet,
  leftmargin=2em,
  itemsep=3pt,
  parsep=0pt
}

\setlist[enumerate,1]{
  label=(\alph*),
  leftmargin=2em,
  itemsep=3pt,
  parsep=0pt
}

\setlist[itemize,2]{
  label=\textendash,
  leftmargin=1.5em
}

% -----------------------------------------------------------------------------
% BIBLIOGRAPHY
% -----------------------------------------------------------------------------
\usepackage[
  backend=biber,
  style=authoryear,
  sorting=nyt,
  natbib=true,
  maxcitenames=2,
  maxbibnames=10
]{biblatex}

% -----------------------------------------------------------------------------
% HYPERLINKS - Blue citations (#2471A3), red URLs (#AA0000)
% -----------------------------------------------------------------------------
\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  linkcolor=black,
  citecolor=citeblue,
  urlcolor=urlred,
  pdfauthor={},
  pdftitle={}
}

% -----------------------------------------------------------------------------
% MISCELLANEOUS
% -----------------------------------------------------------------------------
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{caption}
\usepackage{float}

\captionsetup{
  font=small,
  labelfont=bf,
  margin=0pt
}

\widowpenalty=10000
\clubpenalty=10000

% -----------------------------------------------------------------------------
% CUSTOM COMMANDS
% -----------------------------------------------------------------------------
\newcommand{\term}[1]{\textit{#1}}
\newcommand{\tech}[1]{\texttt{#1}}
\renewcommand{\strong}[1]{\textbf{#1}}
